<div class="container">
  <div class="row">
    <div class="col-md-8">
      <% if @product.image.attached? %>
        <%= image_tag @product.image, class: "img-fluid mb-4" %>
      <% end %>
      <h1><%= @product.name %></h1>
      <p class="text-muted">Listed by <%= @product.user.name %></p>
      
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Description</h5>
          <p class="card-text"><%= @product.description %></p>
        </div>
      </div>

      <div class="mb-4">
        <h5>Categories</h5>
        <% @product.categories.each do |category| %>
          <span class="badge bg-secondary"><%= category.name %></span>
        <% end %>
      </div>

      <div class="mb-4">
        <h3 class="text-primary"><%= number_to_currency(@product.price) %></h3>
      </div>

      <%= button_to "Add to Cart", line_items_path(product_id: @product), class: "btn btn-primary" %>

      <% if user_signed_in? && @product.user == current_user %>
        <div class="btn-group mt-3">
          <%= link_to "Edit", edit_product_path(@product), class: "btn btn-outline-primary" %>
          <%= button_to "Delete", product_path(@product), method: :delete, 
              data: { confirm: "Are you sure you want to delete this product?" }, 
              class: "btn btn-outline-danger" %>
        </div>
      <% end %>

      <div class="mt-5">
        <h4>Customer Reviews</h4>
        <div class="mb-4">
          <% if @product.reviews.any? %>
            <div class="mb-3">
              <h5>Average Rating: <%= @product.reviews.average(:rating).round(1) %> / 5</h5>
            </div>
            
            <% @product.reviews.includes(:user).each do |review| %>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="card-subtitle mb-2 text-muted"><%= review.user.name %></h6>
                    <div class="text-warning">
                      <% review.rating.times do %>
                        ★
                      <% end %>
                      <% (5 - review.rating).times do %>
                        ☆
                      <% end %>
                    </div>
                  </div>
                  <p class="card-text"><%= review.comment %></p>
                  <% if current_user == review.user %>
                    <%= button_to "Delete Review", product_review_path(@product, review), 
                        method: :delete,
                        class: "btn btn-sm btn-outline-danger",
                        data: { confirm: "Are you sure you want to delete this review?" } %>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted">No reviews yet. Be the first to review this product!</p>
          <% end %>
        </div>

        <% if user_signed_in? && current_user != @product.user && !@product.reviews.exists?(user: current_user) %>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Write a Review</h5>
              <%= form_for [@product, Review.new] do |f| %>
                <div class="form-group mb-3">
                  <%= f.label :rating, "Rating" %>
                  <%= f.select :rating, options_for_select(1..5), {}, class: "form-select" %>
                </div>
                
                <div class="form-group mb-3">
                  <%= f.label :comment, "Your Review" %>
                  <%= f.text_area :comment, class: "form-control", rows: 3, 
                      placeholder: "Share your thoughts about this product..." %>
                </div>

                <%= f.submit "Post Review", class: "btn btn-primary" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
