<%# Modern Enhanced Shopping Cart %>
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-purple-50 py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <%# Header %>
    <div class="mb-8">
      <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Shopping Cart</h1>
      <p class="text-gray-600">
        <%= pluralize(@cart_items.sum(:quantity), 'item') %> in your cart
      </p>
    </div>

    <% if @cart_items.any? %>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <%# Cart Items Column %>
        <div class="lg:col-span-2 space-y-4">
          
          <%# Select All Checkbox %>
          <div class="card-modern p-4 flex items-center gap-3" data-controller="cart-selection">
            <input type="checkbox" 
                   id="select-all"
                   class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                   data-action="change->cart-selection#toggleAll"
                   data-cart-selection-target="selectAll">
            <label for="select-all" class="flex-1 text-sm font-medium text-gray-700 cursor-pointer">
              Select all items
            </label>
            
            <button class="btn-ghost text-sm py-2 px-4"
                    data-action="click->cart-selection#deleteSelected">
              Delete selected
            </button>
          </div>

          <%# Cart Items %>
          <div class="space-y-4" data-controller="enhanced-cart">
            <% @cart_items.each do |item| %>
              <div class="cart-item group" data-item-id="<%= item.id %>">
                
                <%# Checkbox %>
                <div class="flex items-start">
                  <input type="checkbox" 
                         class="mt-6 w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                         data-cart-selection-target="checkbox"
                         data-item-id="<%= item.id %>">
                </div>

                <%# Product Image %>
                <%= link_to product_path(item.product), class: "cart-item-image" do %>
                  <% if item.product.images&.first&.attached? %>
                    <%= image_tag item.product.images.first.variant(resize_to_limit: [200, 200]), 
                        alt: item.product.name,
                        class: "w-full h-full object-cover transition-transform group-hover:scale-110" %>
                  <% else %>
                    <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                      <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                  <% end %>
                <% end %>

                <%# Product Details %>
                <div class="flex-1 min-w-0">
                  <%= link_to product_path(item.product), class: "block group" do %>
                    <h3 class="text-lg font-bold text-gray-900 mb-1 group-hover:text-purple-600 transition-colors">
                      <%= item.product.name %>
                    </h3>
                  <% end %>
                  
                  <%# Seller %>
                  <p class="text-sm text-gray-600 mb-3">
                    Sold by <%= link_to item.product.user.name, user_path(item.product.user), 
                                class: "text-purple-600 hover:text-purple-700 font-medium" %>
                  </p>
                  
                  <%# Variant Info (if applicable) %>
                  <% if item.variant.present? %>
                    <div class="flex flex-wrap gap-2 mb-3">
                      <% item.variant.options.each do |option| %>
                        <span class="badge badge-outline text-xs">
                          <%= option.name %>: <%= option.value %>
                        </span>
                      <% end %>
                    </div>
                  <% end %>
                  
                  <%# Stock Status %>
                  <% if item.product.stock_quantity > 10 %>
                    <p class="text-sm text-green-600 font-medium">In Stock</p>
                  <% elsif item.product.stock_quantity > 0 %>
                    <p class="text-sm text-orange-600 font-medium">
                      Only <%= item.product.stock_quantity %> left
                    </p>
                  <% else %>
                    <p class="text-sm text-red-600 font-medium">Out of Stock</p>
                  <% end %>
                  
                  <%# Actions %>
                  <div class="flex gap-4 mt-4">
                    <button class="text-sm text-gray-600 hover:text-purple-600 font-medium transition-colors"
                            data-action="click->enhanced-cart#moveToWishlist"
                            data-item-id="<%= item.id %>">
                      üíú Move to Wishlist
                    </button>
                    
                    <%= button_to cart_item_path(item), 
                        method: :delete,
                        class: "text-sm text-gray-600 hover:text-red-600 font-medium transition-colors",
                        data: { 
                          turbo: true,
                          turbo_confirm: "Remove this item from cart?"
                        } do %>
                      üóëÔ∏è Remove
                    <% end %>
                  </div>
                </div>

                <%# Quantity & Price %>
                <div class="flex flex-col items-end gap-4">
                  
                  <%# Quantity Selector %>
                  <div class="flex items-center border-2 border-gray-300 rounded-lg overflow-hidden"
                       data-controller="quantity"
                       data-item-id="<%= item.id %>">
                    
                    <%= button_to cart_item_path(item), 
                        method: :patch,
                        params: { quantity: [item.quantity - 1, 1].max },
                        class: "px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors",
                        data: { turbo: true } do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                      </svg>
                    <% end %>
                    
                    <span class="px-4 py-2 min-w-[3rem] text-center font-bold">
                      <%= item.quantity %>
                    </span>
                    
                    <%= button_to cart_item_path(item), 
                        method: :patch,
                        params: { quantity: item.quantity + 1 },
                        class: "px-3 py-2 bg-gray-100 hover:bg-gray-200 transition-colors",
                        data: { turbo: true } do %>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                      </svg>
                    <% end %>
                  </div>
                  
                  <%# Price %>
                  <div class="text-right">
                    <% if item.product.discount_price.present? %>
                      <div class="text-sm text-gray-500 line-through">
                        <%= number_to_currency(item.product.price * item.quantity) %>
                      </div>
                      <div class="text-2xl font-bold text-gray-900">
                        <%= number_to_currency(item.product.discount_price * item.quantity) %>
                      </div>
                      <div class="text-xs text-red-600 font-semibold">
                        Save <%= number_to_currency((item.product.price - item.product.discount_price) * item.quantity) %>
                      </div>
                    <% else %>
                      <div class="text-2xl font-bold text-gray-900">
                        <%= number_to_currency(item.product.price * item.quantity) %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <%# Continue Shopping %>
          <div class="mt-8">
            <%= link_to products_path, class: "btn-ghost inline-flex items-center gap-2" do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              <span>Continue Shopping</span>
            <% end %>
          </div>
        </div>

        <%# Order Summary Sidebar %>
        <div class="lg:col-span-1">
          <div class="sticky top-24">
            <div class="cart-summary space-y-6">
              
              <h2 class="text-2xl font-bold text-white">Order Summary</h2>
              
              <%# Price Breakdown %>
              <div class="space-y-3">
                <div class="flex justify-between text-white/90">
                  <span>Subtotal (<%= pluralize(@cart_items.sum(:quantity), 'item') %>)</span>
                  <span class="font-semibold">
                    <%= number_to_currency(@cart.subtotal) %>
                  </span>
                </div>
                
                <% if @cart.total_discount > 0 %>
                  <div class="flex justify-between text-green-300">
                    <span>Discount</span>
                    <span class="font-semibold">
                      -<%= number_to_currency(@cart.total_discount) %>
                    </span>
                  </div>
                <% end %>
                
                <div class="flex justify-between text-white/90">
                  <span>Shipping</span>
                  <span class="font-semibold">
                    <% if @cart.subtotal >= 50 %>
                      <span class="text-green-300">FREE</span>
                    <% else %>
                      <%= number_to_currency(9.99) %>
                    <% end %>
                  </span>
                </div>
                
                <div class="flex justify-between text-white/90">
                  <span>Tax (estimated)</span>
                  <span class="font-semibold">
                    <%= number_to_currency(@cart.estimated_tax) %>
                  </span>
                </div>
              </div>
              
              <%# Divider %>
              <div class="border-t border-white/20"></div>
              
              <%# Total %>
              <div class="flex justify-between items-baseline">
                <span class="text-xl font-bold text-white">Total</span>
                <span class="text-3xl font-extrabold text-white">
                  <%= number_to_currency(@cart.total) %>
                </span>
              </div>
              
              <%# Checkout Button %>
              <%= link_to checkout_path, 
                  class: "w-full bg-white text-purple-600 hover:bg-gray-50 font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all hover:shadow-2xl" do %>
                <span>Proceed to Checkout</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
              <% end %>
              
              <%# Free Shipping Progress %>
              <% if @cart.subtotal < 50 %>
                <div class="space-y-2">
                  <p class="text-sm text-white/90">
                    Add <%= number_to_currency(50 - @cart.subtotal) %> more for FREE shipping!
                  </p>
                  <div class="w-full h-2 bg-white/20 rounded-full overflow-hidden">
                    <div class="h-full bg-white rounded-full transition-all duration-500"
                         style="width: <%= [@cart.subtotal / 50 * 100, 100].min %>%"></div>
                  </div>
                </div>
              <% end %>
              
              <%# Trust Badges %>
              <div class="space-y-2 text-sm text-white/80">
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  <span>Secure checkout</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />
                  </svg>
                  <span>Fast & reliable delivery</span>
                </div>
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                  </svg>
                  <span>Easy 30-day returns</span>
                </div>
              </div>
            </div>

            <%# Promo Code %>
            <div class="card-modern p-6 mt-6" data-controller="promo-code">
              <h3 class="font-bold text-gray-900 mb-3">Have a promo code?</h3>
              <%= form_with url: apply_promo_code_path, method: :post, class: "flex gap-2" do |f| %>
                <%= f.text_field :code, 
                    placeholder: "Enter code",
                    class: "flex-1 input-modern" %>
                <%= f.submit "Apply", 
                    class: "btn-primary px-6" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <%# Empty Cart State %>
      <div class="card-modern p-12 text-center">
        <svg class="w-32 h-32 mx-auto text-gray-400 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Your cart is empty</h2>
        <p class="text-gray-600 mb-8">Looks like you haven't added any items to your cart yet.</p>
        
        <%= link_to "Start Shopping", products_path, 
            class: "btn-primary inline-flex items-center gap-2 text-lg px-8 py-4" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <span>Browse Products</span>
        <% end %>
        
        <%# Recently Viewed %>
        <% if @recently_viewed.any? %>
          <div class="mt-12">
            <h3 class="text-xl font-bold text-gray-900 mb-6">Recently Viewed</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <% @recently_viewed.each do |product| %>
                <%= render 'products/card', product: product %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>